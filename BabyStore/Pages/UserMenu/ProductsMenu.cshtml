@page
@model BabyStore.Pages.UserMenu.ProductsMenuModel

@{
    ViewData["Title"] = "ProductsMenu";
    Layout = "~/Pages/Shared/_Layout.cshtml";
    bool isAuthenticated = !string.IsNullOrEmpty(HttpContext.Session.GetString("username"));
}

<h1>ProductsMenu</h1>

<link rel="stylesheet" href="~/css/products.css" />

<div class="product-grid">
    @foreach (var product in Model.Product)
    {
        if (product.Quantity > 0)
        {
            <div class="product-card">
                <a href="@Url.Page("/UserMenu/ProductDetailsMenu", new { id = product.ProductId })">
                    <img src="@product.Image" style="height:100px; width:100%" alt="@product.Name" class="product-image" />
                    <div class="product-info">
                        <h2 class="product-title">@product.Name</h2>
                        <p class="product-price">
                            @string.Format("{0:n0} VNĐ", product.Price)
                        </p>
                    </div>
                </a>
                @if (isAuthenticated)
                {
                    <form method="post" asp-page-handler="AddToCart" asp-route-productId="@product.ProductId" asp-route-productName="@product.Name" asp-route-price="@product.Price" asp-route-productImage="@product.Image" class="d-inline add-to-cart-form">
                        <button type="submit" class="btn btn-primary">
                            <img src="~/images/cart-icon.png" alt="Cart" class="cart-icon" /> Thêm vào giỏ
                        </button>
                    </form>
                }
                else
                {
                    <button class="btn btn-primary login-required">
                        <img src="~/images/cart-icon.png" alt="Cart" class="cart-icon" /> Thêm vào giỏ
                    </button>
                }
            </div>
        }
        else
        {
            <div class="product-card">
                <a href="@Url.Page("/UserMenu/ProductDetailsMenu", new { id = product.ProductId })">
                    <img src="@product.Image" alt="@product.Name" class="product-image" />
                    <div class="product-info">
                        <h2 class="product-title">@product.Name</h2>
                        <p class="product-price">
                            @string.Format("{0:n0} VNĐ", product.Price)
                        </p>
                        <p class="out-of-stock">Sản phẩm này đã hết</p>
                    </div>
                </a>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        document.querySelectorAll('.login-required').forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault();
                alert('Please log in to add items to your cart.');
            });
        });

        document.querySelectorAll('.add-to-cart-form').forEach(form => {
            form.addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent default form submission
                var formData = new FormData(this);
                fetch(this.action, {
                    method: this.method,
                    body: formData,
                }).then(response => {
                    if (response.ok) {
                        alert('Product added to cart');
                    } else {
                        alert('Failed to add product to cart');
                    }
                });
            });
        });
    </script>
}
